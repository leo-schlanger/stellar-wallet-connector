<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Wallet Connector - Manual Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .wallet-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
        }
        .wallet-card.installed { border-color: #28a745; background: #d4edda; }
        .wallet-card.not-installed { border-color: #6c757d; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>üöÄ Stellar Wallet Connector - Manual Test</h1>

    <div class="container">
        <h2>üîç Wallet Status</h2>
        <div id="walletStatus" class="status info">
            Initializing...
        </div>
    </div>

    <div class="container">
        <h2>üì± Available Wallets</h2>
        <div id="walletsGrid" class="wallet-grid">
            <!-- Wallets will be populated here -->
        </div>
    </div>

    <div class="container">
        <h2>üîó Connection Test</h2>
        <div id="connectionStatus" class="status warning">
            Not connected
        </div>
        <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
        <button id="disconnectBtn" onclick="disconnectWallet()" disabled>Disconnect</button>
        <button id="refreshBtn" onclick="refreshStatus()">Refresh Status</button>
    </div>

    <div class="container">
        <h2>‚úçÔ∏è Transaction Signing Test</h2>
        <div id="signingStatus" class="status warning">
            Connect a wallet first
        </div>
        <textarea id="xdrInput" rows="4" placeholder="Paste your XDR transaction here..."></textarea>
        <button id="signBtn" onclick="signTransaction()" disabled>Sign Transaction</button>
        <div id="signedResult"></div>
    </div>

    <div class="container">
        <h2>üå± KALE Farming Test</h2>
        <div id="kaleStatus" class="status warning">
            Connect a wallet first
        </div>
        <div>
            <label>Stake Amount (in stroops):</label>
            <input type="number" id="stakeAmount" value="1000000000" placeholder="1000000000 (1000 KALE)">
        </div>
        <div>
            <label>Work Hash:</label>
            <input type="text" id="workHash" placeholder="Enter hex hash for proof-of-work">
        </div>
        <button id="plantBtn" onclick="plantKale()" disabled>üå± Plant KALE</button>
        <button id="workBtn" onclick="workKale()" disabled>‚ö° Work KALE</button>
        <button id="harvestBtn" onclick="harvestKale()" disabled>üåæ Harvest KALE</button>
        <div id="kaleResult"></div>
    </div>

    <div class="container">
        <h2>üìã Test Results</h2>
        <div id="testResults">
            <div class="status info">Test session started at: <span id="startTime"></span></div>
        </div>
    </div>

    <!-- Load the built packages -->
    <script type="module">
        import { StellarWalletConnector } from './packages/core/dist/index.js';

        // Global variables
        let connector;
        let selectedWallet = null;

        // Initialize
        async function initialize() {
            try {
                console.log('üöÄ Initializing Stellar Wallet Connector...');
                connector = new StellarWalletConnector({
                    network: 'testnet',
                    autoConnect: false
                });

                document.getElementById('startTime').textContent = new Date().toLocaleString();

                updateWalletStatus();
                updateConnectionStatus();
                populateWallets();

                logTest('‚úÖ Connector initialized successfully');
                console.log('‚úÖ Connector initialized with', connector.getAvailableWallets().length, 'wallets');

            } catch (error) {
                console.error('‚ùå Failed to initialize:', error);
                logTest('‚ùå Failed to initialize: ' + error.message, 'error');
            }
        }

        function updateWalletStatus() {
            const available = connector.getAvailableWallets();
            const installed = connector.getInstalledWallets();

            document.getElementById('walletStatus').innerHTML = `
                <strong>Available:</strong> ${available.length}<br>
                <strong>Installed:</strong> ${installed.length}<br>
                <strong>Network:</strong> ${connector.options.network}
            `;
            document.getElementById('walletStatus').className = 'status info';
        }

        function updateConnectionStatus() {
            const isConnected = connector.isConnected();
            const currentWallet = connector.getCurrentWallet();
            const publicKey = connector.getPublicKey();

            const statusEl = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const signBtn = document.getElementById('signBtn');
            const plantBtn = document.getElementById('plantBtn');
            const workBtn = document.getElementById('workBtn');
            const harvestBtn = document.getElementById('harvestBtn');

            if (isConnected && currentWallet) {
                statusEl.innerHTML = `
                    <strong>‚úÖ Connected to ${currentWallet.name}</strong><br>
                    <strong>Public Key:</strong> ${publicKey}
                `;
                statusEl.className = 'status success';

                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                signBtn.disabled = false;
                plantBtn.disabled = false;
                workBtn.disabled = false;
                harvestBtn.disabled = false;
            } else {
                statusEl.innerHTML = '‚ùå Not connected';
                statusEl.className = 'status warning';

                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                signBtn.disabled = true;
                plantBtn.disabled = true;
                workBtn.disabled = true;
                harvestBtn.disabled = true;
            }
        }

        function populateWallets() {
            const wallets = connector.getAvailableWallets();
            const grid = document.getElementById('walletsGrid');

            grid.innerHTML = '';

            wallets.forEach(wallet => {
                const card = document.createElement('div');
                card.className = `wallet-card ${wallet.installed ? 'installed' : 'not-installed'}`;
                card.innerHTML = `
                    <strong>${wallet.name}</strong><br>
                    <small>${wallet.installed ? '‚úÖ Installed' : '‚ùå Not installed'}</small><br>
                    <button onclick="selectWallet('${wallet.id}')" ${!wallet.installed ? 'disabled' : ''}>
                        Select
                    </button>
                `;
                grid.appendChild(card);
            });
        }

        // Global functions for buttons
        window.selectWallet = function(walletId) {
            selectedWallet = walletId;
            const wallet = connector.getAvailableWallets().find(w => w.id === walletId);
            logTest(`üéØ Selected wallet: ${wallet.name} (${walletId})`);
        };

        window.connectWallet = async function() {
            if (!selectedWallet) {
                alert('Please select a wallet first!');
                return;
            }

            try {
                logTest(`üîó Connecting to ${selectedWallet}...`);
                const result = await connector.connect(selectedWallet);
                logTest(`‚úÖ Connected! Public key: ${result.publicKey}`, 'success');
                updateConnectionStatus();
            } catch (error) {
                logTest(`‚ùå Connection failed: ${error.message}`, 'error');
                console.error('Connection error:', error);
            }
        };

        window.disconnectWallet = async function() {
            try {
                logTest('üîå Disconnecting...');
                await connector.disconnect();
                logTest('‚úÖ Disconnected successfully', 'success');
                updateConnectionStatus();
            } catch (error) {
                logTest(`‚ùå Disconnect failed: ${error.message}`, 'error');
            }
        };

        window.refreshStatus = function() {
            updateWalletStatus();
            updateConnectionStatus();
            logTest('üîÑ Status refreshed');
        };

        window.signTransaction = async function() {
            const xdr = document.getElementById('xdrInput').value.trim();
            if (!xdr) {
                alert('Please enter an XDR transaction!');
                return;
            }

            try {
                logTest('‚úçÔ∏è Signing transaction...');
                const result = await connector.signTransaction(xdr);
                logTest('‚úÖ Transaction signed successfully!', 'success');

                document.getElementById('signedResult').innerHTML = `
                    <div class="status success">
                        <strong>Signed Transaction:</strong><br>
                        <textarea readonly rows="3">${result.signedXDR}</textarea><br>
                        <strong>Signer:</strong> ${result.signerAddress}
                    </div>
                `;
            } catch (error) {
                logTest(`‚ùå Signing failed: ${error.message}`, 'error');
                document.getElementById('signedResult').innerHTML = `
                    <div class="status error">
                        <strong>Signing Error:</strong> ${error.message}
                    </div>
                `;
            }
        };

        // KALE farming functions
        window.plantKale = async function() {
            const amount = document.getElementById('stakeAmount').value;
            if (!amount || amount <= 0) {
                alert('Please enter a valid stake amount!');
                return;
            }

            try {
                logTest(`üå± Planting ${amount} stroops of KALE...`);
                // This would need the KALE service to be loaded
                alert('KALE farming integration needs to be implemented in the browser environment');
            } catch (error) {
                logTest(`‚ùå Plant failed: ${error.message}`, 'error');
            }
        };

        window.workKale = async function() {
            const hash = document.getElementById('workHash').value.trim();
            if (!hash) {
                alert('Please enter a work hash!');
                return;
            }

            try {
                logTest(`‚ö° Submitting work with hash: ${hash}...`);
                alert('KALE farming integration needs to be implemented in the browser environment');
            } catch (error) {
                logTest(`‚ùå Work failed: ${error.message}`, 'error');
            }
        };

        window.harvestKale = async function() {
            try {
                logTest('üåæ Harvesting KALE rewards...');
                alert('KALE farming integration needs to be implemented in the browser environment');
            } catch (error) {
                logTest(`‚ùå Harvest failed: ${error.message}`, 'error');
            }
        };

        function logTest(message, type = 'info') {
            console.log(message);
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `status ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            results.appendChild(logEntry);

            // Scroll to bottom
            results.scrollTop = results.scrollHeight;
        }

        // Initialize when page loads
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
